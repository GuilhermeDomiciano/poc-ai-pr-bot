# POC AI PR Bot

A proof-of-concept bot that reads a GitHub Issue, asks a CrewAI workflow to generate code changes, applies those changes in a cloned repository, commits/pushes a branch, and opens a Pull Request.

## What It Does

1. Reads issue data from GitHub (`ISSUE_NUMBER`).
2. Clones the target repository into `/work/repo`.
3. Runs a CrewAI flow (`dev`, `qa`, `git` agents).
4. Expects a final JSON payload with:
   - `files` (path -> full file content)
   - `branch`
   - `commit`
   - `pr_title`
   - `pr_body`
5. Writes files, creates a new branch, commits, pushes, and tries to create a PR.

## Architecture (Current)

The project now follows a modular monolith structure:

- `main.py`: entrypoint only (load env, wire dependencies, call use case).
- `application/run_issue_flow.py`: main use case orchestration.
- `domain/models.py`: domain model (`ChangeSet`).
- `domain/payload_parser.py`: robust JSON extraction + payload validation.
- `infrastructure/ai/`: Crew flow and runner.
- `infrastructure/github/`: GitHub API client and gateways.
- `infrastructure/repo/`: git/repo operations and file writer.



## Requirements

- Python 3.10-3.13 (CrewAI pinned version is not compatible with Python 3.14).
- Git installed.
- GitHub token with repository write + PR permissions.
- OpenAI API key.

## Setup

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
```

Edit `.env`:

```env
# Required for CLI and HTTP
OPENAI_API_KEY=...
GITHUB_TOKEN=...

# Required for CLI (`python main.py`)
GH_OWNER=your-org-or-user
GH_REPO=your-repo
ISSUE_NUMBER=1

# Optional
GH_BASE_BRANCH=main
GIT_AUTHOR_NAME=AI Bot
GIT_AUTHOR_EMAIL=ai-bot@example.com
```

For HTTP mode (`POST /workflow/run`), `owner`, `repo` and `issue_number` come from request payload; `OPENAI_API_KEY` and `GITHUB_TOKEN` are still required in environment.

## Run

```bash
python main.py
```

Or with Docker:

```bash
docker compose up --build
```

## Expected Behavior

- Each successful run creates and pushes a branch (as generated by the Crew output).
- PR creation targets `main` by default, or `GH_BASE_BRANCH` if set.
- If the base branch does not exist on remote, the bot skips PR creation and exits cleanly after pushing.
- Git command logs keep the `>>` prefix.

## Notes

- This is a POC and currently has no committed automated tests.
- The bot writes **full file contents** from AI output, not diffs.
- Use a test repository first before running against production repos.
- Current `docker-compose.yml` mounts `./work:/work`; make sure the host `work/` directory is writable for container execution.
